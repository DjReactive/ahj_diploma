!function(){var t={9662:function(t,e,n){var r=n(7854),i=n(614),o=n(6330),s=r.TypeError;t.exports=function(t){if(i(t))return t;throw s(o(t)+" is not a function")}},6077:function(t,e,n){var r=n(7854),i=n(614),o=r.String,s=r.TypeError;t.exports=function(t){if("object"==typeof t||i(t))return t;throw s("Can't set "+o(t)+" as a prototype")}},9670:function(t,e,n){var r=n(7854),i=n(111),o=r.String,s=r.TypeError;t.exports=function(t){if(i(t))return t;throw s(o(t)+" is not an object")}},4019:function(t){t.exports="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView},260:function(t,e,n){"use strict";var r,i,o,s=n(4019),a=n(9781),c=n(7854),u=n(614),l=n(111),h=n(2597),d=n(648),f=n(6330),p=n(8880),m=n(1320),v=n(3070).f,y=n(7976),b=n(9518),g=n(7674),w=n(5112),_=n(9711),S=c.Int8Array,x=S&&S.prototype,A=c.Uint8ClampedArray,E=A&&A.prototype,T=S&&b(S),L=x&&b(x),I=Object.prototype,C=c.TypeError,k=w("toStringTag"),O=_("TYPED_ARRAY_TAG"),M=_("TYPED_ARRAY_CONSTRUCTOR"),j=s&&!!g&&"Opera"!==d(c.opera),$=!1,P={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},R={BigInt64Array:8,BigUint64Array:8},q=function(t){if(!l(t))return!1;var e=d(t);return h(P,e)||h(R,e)};for(r in P)(o=(i=c[r])&&i.prototype)?p(o,M,i):j=!1;for(r in R)(o=(i=c[r])&&i.prototype)&&p(o,M,i);if((!j||!u(T)||T===Function.prototype)&&(T=function(){throw C("Incorrect invocation")},j))for(r in P)c[r]&&g(c[r],T);if((!j||!L||L===I)&&(L=T.prototype,j))for(r in P)c[r]&&g(c[r].prototype,L);if(j&&b(E)!==L&&g(E,L),a&&!h(L,k))for(r in $=!0,v(L,k,{get:function(){return l(this)?this[O]:void 0}}),P)c[r]&&p(c[r],O,r);t.exports={NATIVE_ARRAY_BUFFER_VIEWS:j,TYPED_ARRAY_CONSTRUCTOR:M,TYPED_ARRAY_TAG:$&&O,aTypedArray:function(t){if(q(t))return t;throw C("Target is not a typed array")},aTypedArrayConstructor:function(t){if(u(t)&&(!g||y(T,t)))return t;throw C(f(t)+" is not a typed array constructor")},exportTypedArrayMethod:function(t,e,n,r){if(a){if(n)for(var i in P){var o=c[i];if(o&&h(o.prototype,t))try{delete o.prototype[t]}catch(n){try{o.prototype[t]=e}catch(t){}}}L[t]&&!n||m(L,t,n?e:j&&x[t]||e,r)}},exportTypedArrayStaticMethod:function(t,e,n){var r,i;if(a){if(g){if(n)for(r in P)if((i=c[r])&&h(i,t))try{delete i[t]}catch(t){}if(T[t]&&!n)return;try{return m(T,t,n?e:j&&T[t]||e)}catch(t){}}for(r in P)!(i=c[r])||i[t]&&!n||m(i,t,e)}},isView:function(t){if(!l(t))return!1;var e=d(t);return"DataView"===e||h(P,e)||h(R,e)},isTypedArray:q,TypedArray:T,TypedArrayPrototype:L}},1589:function(t,e,n){var r=n(7854),i=n(1400),o=n(6244),s=n(6135),a=r.Array,c=Math.max;t.exports=function(t,e,n){for(var r=o(t),u=i(e,r),l=i(void 0===n?r:n,r),h=a(c(l-u,0)),d=0;u<l;u++,d++)s(h,d,t[u]);return h.length=d,h}},4362:function(t,e,n){var r=n(1589),i=Math.floor,o=function(t,e){var n=t.length,c=i(n/2);return n<8?s(t,e):a(t,o(r(t,0,c),e),o(r(t,c),e),e)},s=function(t,e){for(var n,r,i=t.length,o=1;o<i;){for(r=o,n=t[o];r&&e(t[r-1],n)>0;)t[r]=t[--r];r!==o++&&(t[r]=n)}return t},a=function(t,e,n,r){for(var i=e.length,o=n.length,s=0,a=0;s<i||a<o;)t[s+a]=s<i&&a<o?r(e[s],n[a])<=0?e[s++]:n[a++]:s<i?e[s++]:n[a++];return t};t.exports=o},4326:function(t,e,n){var r=n(1702),i=r({}.toString),o=r("".slice);t.exports=function(t){return o(i(t),8,-1)}},648:function(t,e,n){var r=n(7854),i=n(1694),o=n(614),s=n(4326),a=n(5112)("toStringTag"),c=r.Object,u="Arguments"==s(function(){return arguments}());t.exports=i?s:function(t){var e,n,r;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(n=function(t,e){try{return t[e]}catch(t){}}(e=c(t),a))?n:u?s(e):"Object"==(r=s(e))&&o(e.callee)?"Arguments":r}},9920:function(t,e,n){var r=n(7293);t.exports=!r((function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}))},8880:function(t,e,n){var r=n(9781),i=n(3070),o=n(9114);t.exports=r?function(t,e,n){return i.f(t,e,o(1,n))}:function(t,e,n){return t[e]=n,t}},9114:function(t){t.exports=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}}},6135:function(t,e,n){"use strict";var r=n(4948),i=n(3070),o=n(9114);t.exports=function(t,e,n){var s=r(e);s in t?i.f(t,s,o(0,n)):t[s]=n}},9781:function(t,e,n){var r=n(7293);t.exports=!r((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]}))},317:function(t,e,n){var r=n(7854),i=n(111),o=r.document,s=i(o)&&i(o.createElement);t.exports=function(t){return s?o.createElement(t):{}}},8886:function(t,e,n){var r=n(8113).match(/firefox\/(\d+)/i);t.exports=!!r&&+r[1]},256:function(t,e,n){var r=n(8113);t.exports=/MSIE|Trident/.test(r)},8113:function(t,e,n){var r=n(5005);t.exports=r("navigator","userAgent")||""},7392:function(t,e,n){var r,i,o=n(7854),s=n(8113),a=o.process,c=o.Deno,u=a&&a.versions||c&&c.version,l=u&&u.v8;l&&(i=(r=l.split("."))[0]>0&&r[0]<4?1:+(r[0]+r[1])),!i&&s&&(!(r=s.match(/Edge\/(\d+)/))||r[1]>=74)&&(r=s.match(/Chrome\/(\d+)/))&&(i=+r[1]),t.exports=i},8008:function(t,e,n){var r=n(8113).match(/AppleWebKit\/(\d+)\./);t.exports=!!r&&+r[1]},7293:function(t){t.exports=function(t){try{return!!t()}catch(t){return!0}}},4374:function(t,e,n){var r=n(7293);t.exports=!r((function(){var t=function(){}.bind();return"function"!=typeof t||t.hasOwnProperty("prototype")}))},6916:function(t,e,n){var r=n(4374),i=Function.prototype.call;t.exports=r?i.bind(i):function(){return i.apply(i,arguments)}},6530:function(t,e,n){var r=n(9781),i=n(2597),o=Function.prototype,s=r&&Object.getOwnPropertyDescriptor,a=i(o,"name"),c=a&&"something"===function(){}.name,u=a&&(!r||r&&s(o,"name").configurable);t.exports={EXISTS:a,PROPER:c,CONFIGURABLE:u}},1702:function(t,e,n){var r=n(4374),i=Function.prototype,o=i.bind,s=i.call,a=r&&o.bind(s,s);t.exports=r?function(t){return t&&a(t)}:function(t){return t&&function(){return s.apply(t,arguments)}}},5005:function(t,e,n){var r=n(7854),i=n(614),o=function(t){return i(t)?t:void 0};t.exports=function(t,e){return arguments.length<2?o(r[t]):r[t]&&r[t][e]}},8173:function(t,e,n){var r=n(9662);t.exports=function(t,e){var n=t[e];return null==n?void 0:r(n)}},7854:function(t,e,n){var r=function(t){return t&&t.Math==Math&&t};t.exports=r("object"==typeof globalThis&&globalThis)||r("object"==typeof window&&window)||r("object"==typeof self&&self)||r("object"==typeof n.g&&n.g)||function(){return this}()||Function("return this")()},2597:function(t,e,n){var r=n(1702),i=n(7908),o=r({}.hasOwnProperty);t.exports=Object.hasOwn||function(t,e){return o(i(t),e)}},3501:function(t){t.exports={}},4664:function(t,e,n){var r=n(9781),i=n(7293),o=n(317);t.exports=!r&&!i((function(){return 7!=Object.defineProperty(o("div"),"a",{get:function(){return 7}}).a}))},2788:function(t,e,n){var r=n(1702),i=n(614),o=n(5465),s=r(Function.toString);i(o.inspectSource)||(o.inspectSource=function(t){return s(t)}),t.exports=o.inspectSource},9909:function(t,e,n){var r,i,o,s=n(8536),a=n(7854),c=n(1702),u=n(111),l=n(8880),h=n(2597),d=n(5465),f=n(6200),p=n(3501),m="Object already initialized",v=a.TypeError,y=a.WeakMap;if(s||d.state){var b=d.state||(d.state=new y),g=c(b.get),w=c(b.has),_=c(b.set);r=function(t,e){if(w(b,t))throw new v(m);return e.facade=t,_(b,t,e),e},i=function(t){return g(b,t)||{}},o=function(t){return w(b,t)}}else{var S=f("state");p[S]=!0,r=function(t,e){if(h(t,S))throw new v(m);return e.facade=t,l(t,S,e),e},i=function(t){return h(t,S)?t[S]:{}},o=function(t){return h(t,S)}}t.exports={set:r,get:i,has:o,enforce:function(t){return o(t)?i(t):r(t,{})},getterFor:function(t){return function(e){var n;if(!u(e)||(n=i(e)).type!==t)throw v("Incompatible receiver, "+t+" required");return n}}}},614:function(t){t.exports=function(t){return"function"==typeof t}},111:function(t,e,n){var r=n(614);t.exports=function(t){return"object"==typeof t?null!==t:r(t)}},1913:function(t){t.exports=!1},2190:function(t,e,n){var r=n(7854),i=n(5005),o=n(614),s=n(7976),a=n(3307),c=r.Object;t.exports=a?function(t){return"symbol"==typeof t}:function(t){var e=i("Symbol");return o(e)&&s(e.prototype,c(t))}},6244:function(t,e,n){var r=n(7466);t.exports=function(t){return r(t.length)}},133:function(t,e,n){var r=n(7392),i=n(7293);t.exports=!!Object.getOwnPropertySymbols&&!i((function(){var t=Symbol();return!String(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&r&&r<41}))},8536:function(t,e,n){var r=n(7854),i=n(614),o=n(2788),s=r.WeakMap;t.exports=i(s)&&/native code/.test(o(s))},3070:function(t,e,n){var r=n(7854),i=n(9781),o=n(4664),s=n(3353),a=n(9670),c=n(4948),u=r.TypeError,l=Object.defineProperty,h=Object.getOwnPropertyDescriptor;e.f=i?s?function(t,e,n){if(a(t),e=c(e),a(n),"function"==typeof t&&"prototype"===e&&"value"in n&&"writable"in n&&!n.writable){var r=h(t,e);r&&r.writable&&(t[e]=n.value,n={configurable:"configurable"in n?n.configurable:r.configurable,enumerable:"enumerable"in n?n.enumerable:r.enumerable,writable:!1})}return l(t,e,n)}:l:function(t,e,n){if(a(t),e=c(e),a(n),o)try{return l(t,e,n)}catch(t){}if("get"in n||"set"in n)throw u("Accessors not supported");return"value"in n&&(t[e]=n.value),t}},9518:function(t,e,n){var r=n(7854),i=n(2597),o=n(614),s=n(7908),a=n(6200),c=n(9920),u=a("IE_PROTO"),l=r.Object,h=l.prototype;t.exports=c?l.getPrototypeOf:function(t){var e=s(t);if(i(e,u))return e[u];var n=e.constructor;return o(n)&&e instanceof n?n.prototype:e instanceof l?h:null}},7976:function(t,e,n){var r=n(1702);t.exports=r({}.isPrototypeOf)},7674:function(t,e,n){var r=n(1702),i=n(9670),o=n(6077);t.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=r(Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set))(n,[]),e=n instanceof Array}catch(t){}return function(n,r){return i(n),o(r),e?t(n,r):n.__proto__=r,n}}():void 0)},2140:function(t,e,n){var r=n(7854),i=n(6916),o=n(614),s=n(111),a=r.TypeError;t.exports=function(t,e){var n,r;if("string"===e&&o(n=t.toString)&&!s(r=i(n,t)))return r;if(o(n=t.valueOf)&&!s(r=i(n,t)))return r;if("string"!==e&&o(n=t.toString)&&!s(r=i(n,t)))return r;throw a("Can't convert object to primitive value")}},1320:function(t,e,n){var r=n(7854),i=n(614),o=n(2597),s=n(8880),a=n(3505),c=n(2788),u=n(9909),l=n(6530).CONFIGURABLE,h=u.get,d=u.enforce,f=String(String).split("String");(t.exports=function(t,e,n,c){var u,h=!!c&&!!c.unsafe,p=!!c&&!!c.enumerable,m=!!c&&!!c.noTargetGet,v=c&&void 0!==c.name?c.name:e;i(n)&&("Symbol("===String(v).slice(0,7)&&(v="["+String(v).replace(/^Symbol\(([^)]*)\)/,"$1")+"]"),(!o(n,"name")||l&&n.name!==v)&&s(n,"name",v),(u=d(n)).source||(u.source=f.join("string"==typeof v?v:""))),t!==r?(h?!m&&t[e]&&(p=!0):delete t[e],p?t[e]=n:s(t,e,n)):p?t[e]=n:a(e,n)})(Function.prototype,"toString",(function(){return i(this)&&h(this).source||c(this)}))},4488:function(t,e,n){var r=n(7854).TypeError;t.exports=function(t){if(null==t)throw r("Can't call method on "+t);return t}},3505:function(t,e,n){var r=n(7854),i=Object.defineProperty;t.exports=function(t,e){try{i(r,t,{value:e,configurable:!0,writable:!0})}catch(n){r[t]=e}return e}},6200:function(t,e,n){var r=n(2309),i=n(9711),o=r("keys");t.exports=function(t){return o[t]||(o[t]=i(t))}},5465:function(t,e,n){var r=n(7854),i=n(3505),o="__core-js_shared__",s=r[o]||i(o,{});t.exports=s},2309:function(t,e,n){var r=n(1913),i=n(5465);(t.exports=function(t,e){return i[t]||(i[t]=void 0!==e?e:{})})("versions",[]).push({version:"3.21.1",mode:r?"pure":"global",copyright:"© 2014-2022 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.21.1/LICENSE",source:"https://github.com/zloirock/core-js"})},1400:function(t,e,n){var r=n(9303),i=Math.max,o=Math.min;t.exports=function(t,e){var n=r(t);return n<0?i(n+e,0):o(n,e)}},9303:function(t){var e=Math.ceil,n=Math.floor;t.exports=function(t){var r=+t;return r!=r||0===r?0:(r>0?n:e)(r)}},7466:function(t,e,n){var r=n(9303),i=Math.min;t.exports=function(t){return t>0?i(r(t),9007199254740991):0}},7908:function(t,e,n){var r=n(7854),i=n(4488),o=r.Object;t.exports=function(t){return o(i(t))}},4590:function(t,e,n){var r=n(7854),i=n(3002),o=r.RangeError;t.exports=function(t,e){var n=i(t);if(n%e)throw o("Wrong offset");return n}},3002:function(t,e,n){var r=n(7854),i=n(9303),o=r.RangeError;t.exports=function(t){var e=i(t);if(e<0)throw o("The argument can't be less than 0");return e}},7593:function(t,e,n){var r=n(7854),i=n(6916),o=n(111),s=n(2190),a=n(8173),c=n(2140),u=n(5112),l=r.TypeError,h=u("toPrimitive");t.exports=function(t,e){if(!o(t)||s(t))return t;var n,r=a(t,h);if(r){if(void 0===e&&(e="default"),n=i(r,t,e),!o(n)||s(n))return n;throw l("Can't convert object to primitive value")}return void 0===e&&(e="number"),c(t,e)}},4948:function(t,e,n){var r=n(7593),i=n(2190);t.exports=function(t){var e=r(t,"string");return i(e)?e:e+""}},1694:function(t,e,n){var r={};r[n(5112)("toStringTag")]="z",t.exports="[object z]"===String(r)},6330:function(t,e,n){var r=n(7854).String;t.exports=function(t){try{return r(t)}catch(t){return"Object"}}},9711:function(t,e,n){var r=n(1702),i=0,o=Math.random(),s=r(1..toString);t.exports=function(t){return"Symbol("+(void 0===t?"":t)+")_"+s(++i+o,36)}},3307:function(t,e,n){var r=n(133);t.exports=r&&!Symbol.sham&&"symbol"==typeof Symbol.iterator},3353:function(t,e,n){var r=n(9781),i=n(7293);t.exports=r&&i((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype}))},5112:function(t,e,n){var r=n(7854),i=n(2309),o=n(2597),s=n(9711),a=n(133),c=n(3307),u=i("wks"),l=r.Symbol,h=l&&l.for,d=c?l:l&&l.withoutSetter||s;t.exports=function(t){if(!o(u,t)||!a&&"string"!=typeof u[t]){var e="Symbol."+t;a&&o(l,t)?u[t]=l[t]:u[t]=c&&h?h(e):d(e)}return u[t]}},3462:function(t,e,n){"use strict";var r=n(7854),i=n(6916),o=n(260),s=n(6244),a=n(4590),c=n(7908),u=n(7293),l=r.RangeError,h=r.Int8Array,d=h&&h.prototype,f=d&&d.set,p=o.aTypedArray,m=o.exportTypedArrayMethod,v=!u((function(){var t=new Uint8ClampedArray(2);return i(f,t,{length:1,0:3},1),3!==t[1]})),y=v&&o.NATIVE_ARRAY_BUFFER_VIEWS&&u((function(){var t=new h(2);return t.set(1),t.set("2",1),0!==t[0]||2!==t[1]}));m("set",(function(t){p(this);var e=a(arguments.length>1?arguments[1]:void 0,1),n=c(t);if(v)return i(f,this,n,e);var r=this.length,o=s(n),u=0;if(o+e>r)throw l("Wrong length");for(;u<o;)this[e+u]=n[u++]}),!v||y)},3824:function(t,e,n){"use strict";var r=n(7854),i=n(1702),o=n(7293),s=n(9662),a=n(4362),c=n(260),u=n(8886),l=n(256),h=n(7392),d=n(8008),f=r.Array,p=c.aTypedArray,m=c.exportTypedArrayMethod,v=r.Uint16Array,y=v&&i(v.prototype.sort),b=!(!y||o((function(){y(new v(2),null)}))&&o((function(){y(new v(2),{})}))),g=!!y&&!o((function(){if(h)return h<74;if(u)return u<67;if(l)return!0;if(d)return d<602;var t,e,n=new v(516),r=f(516);for(t=0;t<516;t++)e=t%4,n[t]=515-t,r[t]=t-2*e+3;for(y(n,(function(t,e){return(t/4|0)-(e/4|0)})),t=0;t<516;t++)if(n[t]!==r[t])return!0}));m("sort",(function(t){return void 0!==t&&s(t),g?y(this,t):a(p(this),function(t){return function(e,n){return void 0!==t?+t(e,n)||0:n!=n?-1:e!=e?1:0===e&&0===n?1/e>0&&1/n<0?1:-1:e>n}}(t))}),!g||b)}},e={};function n(r){var i=e[r];if(void 0!==i)return i.exports;var o=e[r]={exports:{}};return t[r](o,o.exports,n),o.exports}n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.p="",function(){"use strict";n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p;var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};function e(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function r(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function i(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function o(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function s(t,e,n){if(n||2===arguments.length)for(var r,i=0,o=e.length;i<o;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))}function a(t){return this instanceof a?(this.v=t,this):new a(t)}function c(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(t,e||[]),o=[];return r={},s("next"),s("throw"),s("return"),r[Symbol.asyncIterator]=function(){return this},r;function s(t){i[t]&&(r[t]=function(e){return new Promise((function(n,r){o.push([t,e,n,r])>1||c(t,e)}))})}function c(t,e){try{(n=i[t](e)).value instanceof a?Promise.resolve(n.value.v).then(u,l):h(o[0][2],n)}catch(t){h(o[0][3],t)}var n}function u(t){c("next",t)}function l(t){c("throw",t)}function h(t,e){t(e),o.shift(),o.length&&c(o[0][0],o[0][1])}}Object.create,Object.create;var u=function(t){return t&&"number"==typeof t.length&&"function"!=typeof t};function l(t){return"function"==typeof t}var h,d=((h=function(t){return function(e){t(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(t,e){return e+1+") "+t.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}}((function(t){Error.call(t),t.stack=(new Error).stack}))).prototype=Object.create(Error.prototype),h.prototype.constructor=h,h);function f(t,e){if(t){var n=t.indexOf(e);0<=n&&t.splice(n,1)}}var p=function(){function t(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}var e;return t.prototype.unsubscribe=function(){var t,e,n,r,a;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var u=i(c),h=u.next();!h.done;h=u.next())h.value.remove(this)}catch(e){t={error:e}}finally{try{h&&!h.done&&(e=u.return)&&e.call(u)}finally{if(t)throw t.error}}else c.remove(this);var f=this.initialTeardown;if(l(f))try{f()}catch(t){a=t instanceof d?t.errors:[t]}var p=this._finalizers;if(p){this._finalizers=null;try{for(var m=i(p),y=m.next();!y.done;y=m.next()){var b=y.value;try{v(b)}catch(t){a=null!=a?a:[],t instanceof d?a=s(s([],o(a)),o(t.errors)):a.push(t)}}}catch(t){n={error:t}}finally{try{y&&!y.done&&(r=m.return)&&r.call(m)}finally{if(n)throw n.error}}}if(a)throw new d(a)}},t.prototype.add=function(e){var n;if(e&&e!==this)if(this.closed)v(e);else{if(e instanceof t){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=null!==(n=this._finalizers)&&void 0!==n?n:[]).push(e)}},t.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},t.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},t.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&f(e,t)},t.prototype.remove=function(e){var n=this._finalizers;n&&f(n,e),e instanceof t&&e._removeParent(this)},t.EMPTY=((e=new t).closed=!0,e),t}();function m(t){return t instanceof p||t&&"closed"in t&&l(t.remove)&&l(t.add)&&l(t.unsubscribe)}function v(t){l(t)?t():t.unsubscribe()}p.EMPTY;var y=null,b=null,g=void 0,w=!1,_=!1,S={setTimeout:function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=S.delegate;return(null==i?void 0:i.setTimeout)?i.setTimeout.apply(i,s([t,e],o(n))):setTimeout.apply(void 0,s([t,e],o(n)))},clearTimeout:function(t){var e=S.delegate;return((null==e?void 0:e.clearTimeout)||clearTimeout)(t)},delegate:void 0};function x(t){S.setTimeout((function(){if(!y)throw t;y(t)}))}function A(){}var E=T("C",void 0,void 0);function T(t,e,n){return{kind:t,value:e,error:n}}var L=null,I=function(t){function n(e){var n=t.call(this)||this;return n.isStopped=!1,e?(n.destination=e,m(e)&&e.add(n)):n.destination=P,n}return e(n,t),n.create=function(t,e,n){return new M(t,e,n)},n.prototype.next=function(t){this.isStopped?$(function(t){return T("N",t,void 0)}(t),this):this._next(t)},n.prototype.error=function(t){this.isStopped?$(T("E",void 0,t),this):(this.isStopped=!0,this._error(t))},n.prototype.complete=function(){this.isStopped?$(E,this):(this.isStopped=!0,this._complete())},n.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},n.prototype._next=function(t){this.destination.next(t)},n.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},n.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},n}(p),C=Function.prototype.bind;function k(t,e){return C.call(t,e)}var O=function(){function t(t){this.partialObserver=t}return t.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){j(t)}},t.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){j(t)}else j(t)},t.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){j(t)}},t}(),M=function(t){function n(e,n,r){var i,o,s=t.call(this)||this;return l(e)||!e?i={next:null!=e?e:void 0,error:null!=n?n:void 0,complete:null!=r?r:void 0}:s&&_?((o=Object.create(e)).unsubscribe=function(){return s.unsubscribe()},i={next:e.next&&k(e.next,o),error:e.error&&k(e.error,o),complete:e.complete&&k(e.complete,o)}):i=e,s.destination=new O(i),s}return e(n,t),n}(I);function j(t){var e;w?(e=t,w&&L&&(L.errorThrown=!0,L.error=e)):x(t)}function $(t,e){var n=b;n&&S.setTimeout((function(){return n(t,e)}))}var P={closed:!0,next:A,error:function(t){throw t},complete:A},R="function"==typeof Symbol&&Symbol.observable||"@@observable";function q(t){return t}function D(t){return 0===t.length?q:1===t.length?t[0]:function(e){return t.reduce((function(t,e){return e(t)}),e)}}var B=function(){function t(t){t&&(this._subscribe=t)}return t.prototype.lift=function(e){var n=new t;return n.source=this,n.operator=e,n},t.prototype.subscribe=function(t,e,n){var r,i=this,o=(r=t)&&r instanceof I||function(t){return t&&l(t.next)&&l(t.error)&&l(t.complete)}(r)&&m(r)?t:new M(t,e,n);return function(t){if(w){var e=!L;if(e&&(L={errorThrown:!1,error:null}),t(),e){var n=L,r=n.errorThrown,i=n.error;if(L=null,r)throw i}}else t()}((function(){var t=i,e=t.operator,n=t.source;o.add(e?e.call(o,n):n?i._subscribe(o):i._trySubscribe(o))})),o},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},t.prototype.forEach=function(t,e){var n=this;return new(e=U(e))((function(e,r){var i=new M({next:function(e){try{t(e)}catch(t){r(t),i.unsubscribe()}},error:r,complete:e});n.subscribe(i)}))},t.prototype._subscribe=function(t){var e;return null===(e=this.source)||void 0===e?void 0:e.subscribe(t)},t.prototype[R]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return D(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=U(t))((function(t,n){var r;e.subscribe((function(t){return r=t}),(function(t){return n(t)}),(function(){return t(r)}))}))},t.create=function(e){return new t(e)},t}();function U(t){var e;return null!==(e=null!=t?t:g)&&void 0!==e?e:Promise}var F="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function z(t){if(t instanceof B)return t;if(null!=t){if(function(t){return l(t[R])}(t))return h=t,new B((function(t){var e=h[R]();if(l(e.subscribe))return e.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")}));if(u(t))return s=t,new B((function(t){for(var e=0;e<s.length&&!t.closed;e++)t.next(s[e]);t.complete()}));if(l(null==(o=t)?void 0:o.then))return n=t,new B((function(t){n.then((function(e){t.closed||(t.next(e),t.complete())}),(function(e){return t.error(e)})).then(null,x)}));if(function(t){return Symbol.asyncIterator&&l(null==t?void 0:t[Symbol.asyncIterator])}(t))return H(t);if(function(t){return l(null==t?void 0:t[F])}(t))return e=t,new B((function(t){var n,r;try{for(var o=i(e),s=o.next();!s.done;s=o.next()){var a=s.value;if(t.next(a),t.closed)return}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}t.complete()}));if(function(t){return l(null==t?void 0:t.getReader)}(t))return H(function(t){return c(this,arguments,(function(){var e,n,i;return r(this,(function(r){switch(r.label){case 0:e=t.getReader(),r.label=1;case 1:r.trys.push([1,,9,10]),r.label=2;case 2:return[4,a(e.read())];case 3:return n=r.sent(),i=n.value,n.done?[4,a(void 0)]:[3,5];case 4:return[2,r.sent()];case 5:return[4,a(i)];case 6:return[4,r.sent()];case 7:return r.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}}))}))}(t))}var e,n,o,s,h;throw function(t){return new TypeError("You provided "+(null!==t&&"object"==typeof t?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}(t)}function H(t){return new B((function(e){(function(t,e){var n,o,s,a,c,u,l,h;return c=this,u=void 0,h=function(){var c,u;return r(this,(function(r){switch(r.label){case 0:r.trys.push([0,5,6,11]),n=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,n=t[Symbol.asyncIterator];return n?n.call(t):(t=i(t),e={},r("next"),r("throw"),r("return"),e[Symbol.asyncIterator]=function(){return this},e);function r(n){e[n]=t[n]&&function(e){return new Promise((function(r,i){!function(t,e,n,r){Promise.resolve(r).then((function(e){t({value:e,done:n})}),e)}(r,i,(e=t[n](e)).done,e.value)}))}}}(t),r.label=1;case 1:return[4,n.next()];case 2:if((o=r.sent()).done)return[3,4];if(c=o.value,e.next(c),e.closed)return[2];r.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return u=r.sent(),s={error:u},[3,11];case 6:return r.trys.push([6,,9,10]),o&&!o.done&&(a=n.return)?[4,a.call(n)]:[3,8];case 7:r.sent(),r.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}}))},new((l=void 0)||(l=Promise))((function(t,e){function n(t){try{i(h.next(t))}catch(t){e(t)}}function r(t){try{i(h.throw(t))}catch(t){e(t)}}function i(e){var i;e.done?t(e.value):(i=e.value,i instanceof l?i:new l((function(t){t(i)}))).then(n,r)}i((h=h.apply(c,u||[])).next())}))})(t,e).catch((function(t){return e.error(t)}))}))}function N(t){return function(e){if(function(t){return l(null==t?void 0:t.lift)}(e))return e.lift((function(e){try{return t(e,this)}catch(t){this.error(t)}}));throw new TypeError("Unable to lift unknown Observable type")}}function Y(t,e,n,r,i){return new G(t,e,n,r,i)}var G=function(t){function n(e,n,r,i,o,s){var a=t.call(this,e)||this;return a.onFinalize=o,a.shouldUnsubscribe=s,a._next=n?function(t){try{n(t)}catch(t){e.error(t)}}:t.prototype._next,a._error=i?function(t){try{i(t)}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._error,a._complete=r?function(){try{r()}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._complete,a}return e(n,t),n.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;t.prototype.unsubscribe.call(this),!n&&(null===(e=this.onFinalize)||void 0===e||e.call(this))}},n}(I);function W(t,e){return N((function(n,r){var i=0;n.subscribe(Y(r,(function(n){r.next(t.call(e,n,i++))})))}))}function V(t,e,n){return void 0===n&&(n=1/0),l(e)?V((function(n,r){return W((function(t,i){return e(n,t,r,i)}))(z(t(n,r)))}),n):("number"==typeof e&&(n=e),N((function(e,r){return function(t,e,n,r,i,o,s,a){var c=[],u=0,l=0,h=!1,d=function(){!h||c.length||u||e.complete()},f=function(t){return u<r?p(t):c.push(t)},p=function(t){u++;var i=!1;z(n(t,l++)).subscribe(Y(e,(function(t){e.next(t)}),(function(){i=!0}),void 0,(function(){if(i)try{u--;for(var t=function(){var t=c.shift();p(t)};c.length&&u<r;)t();d()}catch(t){e.error(t)}})))};return t.subscribe(Y(e,f,(function(){h=!0,d()}))),function(){}}(e,r,t,n)})))}var K=Array.isArray;var J=["addListener","removeListener"],X=["addEventListener","removeEventListener"],Z=["on","off"];function Q(t,e,n,r){if(l(n)&&(r=n,n=void 0),r)return Q(t,e,n).pipe((i=r,W((function(t){return function(t,e){return K(e)?t.apply(void 0,s([],o(e))):t(e)}(i,t)}))));var i,a=o(function(t){return l(t.addEventListener)&&l(t.removeEventListener)}(t)?X.map((function(r){return function(i){return t[r](e,i,n)}})):function(t){return l(t.addListener)&&l(t.removeListener)}(t)?J.map(tt(t,e)):function(t){return l(t.on)&&l(t.off)}(t)?Z.map(tt(t,e)):[],2),c=a[0],h=a[1];if(!c&&u(t))return V((function(t){return Q(t,e,n)}))(z(t));if(!c)throw new TypeError("Invalid event target");return new B((function(t){var e=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return t.next(1<e.length?e:e[0])};return c(e),function(){return h(e)}}))}function tt(t,e){return function(n){return function(r){return t[n](e,r)}}}n(3462),n(3824);class et{static getFormatedDate(t){const e=new Date(t);return`${et.formatDateNumber(e.getDate())}.${et.formatDateNumber(e.getMonth()+1)}.${et.formatDateNumber(e.getFullYear())} ${et.formatDateNumber(e.getHours())}:${et.formatDateNumber(e.getMinutes())}`}static formatDateNumber(t){return String(t).padStart(2,"0")}static formatTime(t){const e=Math.trunc(t/60),n=t-60*e;return`${String(e).padStart(2,"0")}:${String(n).padStart(2,"0")}`}static formatUrlHTML(t){const e=t.split(" "),n=[];return e.forEach((t=>{/http(s)?:\/\//.test(t)?n.push(`<a class="message__link" href="${t}" target="_blank">${t}</a>`):n.push(t)})),n.join(" ")}static formatTextSize(t,e,n=!0){const r=t.split("."),i=n&&r.length>1&&t.length>e?`...${r[r.length-1]}`:"";return t.substr(0,e)+i}static getPagesCounter(t,e=null){const n=t;return{start:n+1,end:Math.max(n+e,n+1)}}static formatFileSize(t){const e=Number(t)/1024,n=e/1024;return Math.trunc(n)>0?`${n.toFixed(2)}Мб`:`${e.toFixed(2)}Кб`}static checkScrollingDown(t){const e=t.scrollHeight-t.offsetHeight,n=(t.scrollHeight-t.offsetHeight)/10;return t.scrollTop>=e-n}static async blobTob64(t){const e=new FileReader;return e.readAsDataURL(t),new Promise((t=>{e.onload=()=>t(e.result)}))}static b64ArrayToBlob(t){const e=[];return t.forEach((t=>{const n=et.b64toBlob(t.base,t.size);e.push(n)})),e}static b64toBlob(t,e){let n,r,i,o;[n,r]=t.split(","),[i,o]=n.split(";"),[o,n]=i.split(":");const s=n;e=e||512;const a=atob([r]),c=[];for(let t=0;t<a.length;t+=e){const n=a.slice(t,t+e),r=new Array(n.length);for(let t=0;t<n.length;t++)r[t]=n.charCodeAt(t);const i=new Uint8Array(r);c.push(i)}return new Blob(c,{type:s})}}const nt={attachment:[{name:"Изображение",link:"/link1",id:"image",accept:"image/*",icon:"K"},{name:"Документ",link:"/link2",id:"file",accept:"text/*",icon:"H"}]},rt={audio:"f",video:"Z",document:"H",image:"K"};class it{static addLoader(t,e,n=null,r=!0){this.removeLoader(t);const i=document.createElement("img");i.classList.add("loader"),n&&(i.style.width=`${n}px`),i.setAttribute("src","images/tail-spin.svg"),this.loaders.push({[t]:{element:e,content:e.textContent,loader:i,hide:r}}),r&&(e.textContent=""),e.appendChild(i)}static isLoader(t){return!(null===it.getLoaderIndex(t))}static getLoaderIndex(t){for(let e=0;e<it.loaders.length;e++)if(it.loaders[e].hasOwnProperty(t))return e;return null}static removeLoader(t){const e=it.getLoaderIndex(t);null!==e&&(it.loaders[e][t].hide&&(it.loaders[e][t].element.textContent=it.loaders[e][t].content),it.loaders[e][t].loader.remove(),it.loaders.splice(e,1))}}var ot,st,at;at=[],(st="loaders")in(ot=it)?Object.defineProperty(ot,st,{value:at,enumerable:!0,configurable:!0,writable:!0}):ot[st]=at;class ct{constructor(t){this.buttons=[],this.isSending=!1,this.curCtxMenu=null,this.inputBuffer=null,this.builder=t,this.request=t._Request,this.media=t._Media,this.attachments=t._Attachments,this.content=this.builder.content,this.feed=t.feed,this.divSearch=this.builder.divSearch,this.divSending=this.builder.divSending,this.divAttach=this.builder.divAttach,this.titleSpan=this.content.querySelector(".main__title"),this.searchInput=document.getElementById("search"),this.sendInput=document.getElementById("sending"),this.butAttachment=document.getElementById("attachment-link"),this.butSend=document.getElementById("send-link"),this.butAudio=document.getElementById("audio-link"),this.butVideo=document.getElementById("video-link"),this.butAccept=document.getElementById("accept-link"),this.butStop=document.getElementById("stop-link"),this.butSearchToggle=document.getElementById("search-toggle"),this.butSearch=document.getElementById("start-search"),this.createEvents(),this.sendControl(!1)}createEvents(){const t=document.querySelectorAll(".send-button");Array.from(t).forEach((t=>this.buttons.push({element:t,icon:t.textContent}))),document.addEventListener("keydown",(t=>{if("Enter"===t.key)switch(document.activeElement){case this.sendInput:this.preSending("text",this.butSend);break;case this.searchInput:this.startSearch(this.searchInput.value)}})),this.butSend.addEventListener("click",(t=>this.preSending("text",t.target))),this.butAudio.addEventListener("click",(t=>this.preSending("audio",t.target))),this.butVideo.addEventListener("click",(t=>this.preSending("video",t.target))),this.butAttachment.addEventListener("click",(t=>this.toggleMenu(t.target,"attachment"))),this.butSearchToggle.addEventListener("click",(()=>this.searchToggle())),document.addEventListener("click",(t=>{this.buttons.some((e=>e.element===t.target))||this.curCtxMenu&&t.target.closest("div")===this.curCtxMenu.menu||this.toggleMenu(t.target)})),this.butSearch.addEventListener("click",(async()=>this.startSearch(this.searchInput.value))),this.butAccept.addEventListener("click",(()=>{let t;this.switcher(),clearInterval(this.timerId),this.media.stop((async(e,n)=>{it.addLoader("attachment",this.butSend,15),this.isSending=!0;const r=await this.request.send("attachments/generate-id");this.isSending=!1,t="audio"===n?"Аудиозапись":"Видеозапись",t+=` (${this.sendInput.value})`;const i=await this.attachments.setAttachment(n,{id:r,blob:e,name:t});it.removeLoader("attachment"),this.builder.createAttachment(i),this.sendControl(!1,!1)}))})),this.butStop.addEventListener("click",(()=>{this.switcher(),clearInterval(this.timerId),this.media.stop(),this.sendControl(!1,!1)}))}async startSearch(t){it.addLoader("search",this.feed,null,!1);const e=await this.request.send("search",{string:t});if(e.error)return it.removeLoader("search"),void this.builder.showAlert(e.response);this.builder.feedType="search";const n=e.response;if(this.feed.innerHTML="",n.length<1)this.feed.innerHTML="К сожалению, нам не удалось ничего найти";else{for(let t=[],e=n.length-1;e>=0;e--){if(n[e][1].attachCount>0){if(t=await this.request.send("attachments/get",{id:n[e][0]}),t.error){this.builder.showAlert(t.response);continue}}else t=[];this.builder.createPost(n[e],t,"beforeend")}it.removeLoader("search")}}preSending(t,e){if(!this.isSending)switch(t){case"text":this.sendMessage(e);break;case"audio":case"video":this.sendMediaContent(e,t)}}sendMediaContent(t,e){this.attachments.limitExceeded()?this.builder.showAlert("Sorry, limit is exceeded"):(it.addLoader("send",t,15),this.sendControl(!0),this.switcher(),new Promise((t=>t(this.media.start(e)))).then((t=>{it.removeLoader("send"),t.error?(this.switcher(),this.builder.showAlert(t.message)):(this.inputBuffer=this.sendInput.value,this.sendInput.classList.add("toright"),this.sendInput.value="00:00",this.timer=0,this.timerId=setInterval((()=>{this.timer+=1,this.sendInput.value=et.formatTime(this.timer)}),1e3))})))}sendMessage(t){it.addLoader("send",t,15),this.sendControl(!0);const e=[];this.attachments.getAllAttachments().forEach((t=>e.push({id:t.id,type:t.type,name:t.full.name,userfile:"audio"!==t.type&&"video"!==t.type?t.full.file:t.full.blob})));const n={type:"text",message:this.sendInput.value,attachCount:e.length,attachments:e,created:Date.now()};(async()=>{const t=await this.request.send("send",n);if(t.error)return it.removeLoader("send"),this.builder.showAlert(t.response),this.inputBuffer=this.sendInput.value,void this.sendControl(!1,!1);if(e.length>0){for(let t=0;t<e.length;t++)console.log(e[t]),await this.request.send("upload",{id:e[t].id,type:"file",name:e[t].name,content:e[t].userfile});await this.request.send("attachments/add",{token:t.token})}this.attachments.removeAll(),Array.from(this.divAttach.querySelectorAll(".attachment")).forEach((t=>{this.builder.checkAttachments(t,"remove")})),this.feed.scrollTop=0,it.removeLoader("send"),this.sendControl(!1),this.builder._WebSocket.send(JSON.stringify(n))})()}sendControl(t,e=!0){this.isSending=t,t?this.sendInput.setAttribute("disabled",t):(this.sendInput.value=e?"":this.inputBuffer,this.sendInput.classList.remove("toright"),this.sendInput.removeAttribute("disabled"),this.sendInput.focus())}switcher(){this.builder.switchControl(this.butSend,this.butAudio,this.butVideo,this.butAccept,this.butStop)}toggleMenu(t=null,e="close"){this.curCtxMenu&&(this.curCtxMenu.menu.classList.add("animation-contextmenu"),this.buttonToggleIcon(this.curCtxMenu.current),t===this.curCtxMenu.current||"close"===e)?this.curCtxMenu=null:"close"!==e&&(this.isSending||(this.buttonToggleIcon(t),this.curCtxMenu={current:t,menu:this.createMenu(t,e)}))}createMenu(t,e){const n=document.createElement("div");n.classList.add("contextmenu");const r=document.createElement("ul");return r.classList.add("context__list"),n.appendChild(r),nt[e].forEach((t=>{const e=document.createElement("li"),n=document.createElement("a");n.dataset.id=t.id,n.innerHTML=`<span class="ctx__icon">${t.icon}</span> ${t.name}`,e.appendChild(n),e.innerHTML+=`<input type="file" class="load__${t.id}" id="${t.id}" accept="${t.accept}">`,r.appendChild(e)})),this.content.insertAdjacentElement("beforebegin",n),n.classList.add("animation-contextmenu"),this.menuEvents(n),n}menuEvents(t){t.addEventListener("animationend",(e=>{"reverse"!==t.style.animationDirection?(t.classList.remove("animation-contextmenu"),t.style.animationDirection="reverse"):e.target.remove()})),Array.from(t.querySelectorAll("a")).forEach((t=>{t.addEventListener("click",(e=>{document.getElementById(t.dataset.id).dispatchEvent(new MouseEvent("click"))}))})),Array.from(t.querySelectorAll("input[type=file]")).forEach((t=>{t.addEventListener("change",(t=>this.fileCreateAttachments(t.currentTarget.files)))}))}async fileCreateAttachments(t){this.toggleMenu(),it.addLoader("attachment",this.butAttachment,15),this.isSending=!0;const e=t[0],n=await this.request.send("attachments/generate-id");this.isSending=!1;const r=""!==e.type?e.type.split("/"):["document"],i=await et.blobTob64(e),o=await et.b64toBlob(i,e.size),s=await this.attachments.setAttachment(r[0],{id:n,blob:o,file:e,name:e.name});it.removeLoader("attachment"),this.builder.createAttachment(s)}searchToggle(){this.divSearch.classList.contains("search-open-animation")?(this.titleSpan.style.opacity=1,this.divSearch.style.width="0",this.divSearch.style.overflow="hidden"):(this.searchInput.value="",this.searchInput.focus(),this.titleSpan.style.opacity=0,this.divSearch.style.width="100%",this.divSearch.style.overflow="visible"),"feed"!==this.builder.feedType&&(async()=>{for(this.feed.innerHTML="",this.builder.lastItem=null,this.builder.msgCount=null;await this.builder.preloadContent("history"););this.builder.feedType="feed"})(),this.buttonToggleIcon(this.butSearchToggle),this.divSearch.classList.toggle("search-open-animation")}buttonToggleIcon(t){for(let e=0;e<this.buttons.length;e++)if(t===this.buttons[e].element)return this.buttons[e].element.textContent="P"===t.textContent?this.buttons[e].icon:"P",!0;return!1}}class ut{constructor(t,e){const n="active",r="drop__enter",i=e.querySelector(".drop__inside");this.dragged=!1,document.addEventListener("dragleave",(t=>{t.preventDefault(),this.dragged||this.removeClass(e,n)})),document.addEventListener("dragover",(t=>{t.preventDefault(),this.addClass(e,n)})),e.addEventListener("dragenter",(t=>{t.preventDefault(),this.addClass(i,r),this.dragged=!0})),e.addEventListener("dragleave",(t=>{t.preventDefault(),this.removeClass(i,r),this.dragged=!1})),e.addEventListener("drop",(i=>{if(i.preventDefault(),this.removeClass(e,n),this.removeClass(e,r),i.dataTransfer.files.length<1)return;this.dragged=!1;const o=Array.from(i.dataTransfer.files);t._Buttons.fileCreateAttachments(o)}))}addClass(t,e){t.classList.contains(e)||t.classList.add(e)}removeClass(t,e){t.classList.contains(e)&&t.classList.remove(e)}}class lt{constructor(){this.isRequestSend=!1,this.serverURL="https://react-ahj-diploma.herokuapp.com"}send(t,e=null){if(this.isSending)return{error:!0,response:"Request already sending..."};let n,r="";switch(t){case"attachments/add":case"send":n={method:"POST",type:"json"};break;case"upload":n={method:"POST",type:"file"};break;case"upload/remove":r=`/${e.id}`,n={method:"DELETE",type:"json"};break;case"attachments/get":r=`/${e.id}`,n={method:"GET",type:"json"};break;case"/attachments/generate-id":case"pin/get":default:n={method:"GET",type:"json"};break;case"search":r=`/${e.string}`,n={method:"GET",type:"json"};break;case"pin/set":r=`/${e.id}`,n={method:"POST",type:"json"};break;case"feed":e&&e.hasOwnProperty("pages")&&(r=`/${e.pages.start}`),e&&null!==e.pages.end&&(r+=`-${e.pages.end}`),n={method:"GET",type:"json"}}return this.isRequestSend=!0,(async()=>{const i=await this.request(n.method,`${this.serverURL}/${t}${r}`,n.type,e);return this.isRequestSend=!1,i})()}async request(t,e,n,r=null){const i={method:t};if(r&&"GET"!==t)if("file"===n){const t=new FormData;t.append("content",r.content),t.append("type",r.type),t.append("id",r.id),r.name&&t.append("name",r.name),i.body=t}else i.body=JSON.stringify(r),i.headers={"Content-Type":"application/json;charset=utf-8"};try{const t=await fetch(e,i),r=await t.json();return"blob"===n?et.b64ArrayToBlob(r):r}catch(t){return{error:!0,response:t}}}}class ht{constructor(t){this.wsUrl="react-ahj-diploma.herokuapp.com",this.ws=new WebSocket(`wss://${this.wsUrl}/ws`),this.ws.binaryType="blob",this.ignoreListen=null,this.ws.addEventListener("open",(()=>console.log("connected to WS"))),this.ws.addEventListener("close",(t=>console.log("connection closed",t))),this.ws.addEventListener("error",(t=>console.log("error",t)))}send(t){this.ws.send(t)}}class dt{constructor(){this.lastURL=null,this.callback=null,this.type="audio"}initEvents(){this.recorder.addEventListener("dataavailable",(t=>{this.chunks.push(t.data)})),this.recorder.addEventListener("stop",(()=>{const t=new Blob(this.chunks,{type:"audio"===this.type?"audio/mp3":"video/webm"});this.callback(t,this.type)}))}start(t){return this.type=t,(async()=>{try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:"video"===t}),this.recorder=new MediaRecorder(this.stream),this.chunks=[],this.initEvents(),this.recorder.start()}catch(t){return{error:!0,message:t}}return{error:!1}})()}stop(t=(()=>{})){this.callback=t,this.recorder.stop(),this.lastURL=null,this.stream.getTracks().forEach((t=>t.stop()))}}class ft{constructor(t,e){this.counter=1,this.serverUrl=e,this.limitOfAttachments=3,this.attachments=new Map,this.files=new Map}addFile(t){this.files.set(this.counter,t),this.counter+=1}setAttachment(t,e){const{id:n}=e,r=t&&"text"!==t?t:"document";return this.attachments.set(n,{id:n,type:r,name:e.name,blob:e.blob,file:e.file}),this.getAttachment(n)}removeAttachment(t){return this.getAttachment(t),this.attachments.delete(t)?{error:!1}:{error:!0,response:"Filed remove attachment"}}removeAll(t){this.attachments.clear(),this.files.clear(),this.counter=1}limitExceeded(){return this.getAllAttachments().length>=this.limitOfAttachments}getAttachment(t){return this.attachments.get(t)}getAllAttachments(){const t=[];return this.attachments.forEach(((e,n)=>{e&&t.push({id:n,type:e.type,full:e})})),t}getMediaHTML(t,e){const n=t.split("/"),r=`${this.serverUrl}/${e.url}`;return"audio"===n[0]||"video"===n[0]?`\n      <video class="attachment__${n[0]}" src ="${r}" data-id="${e.id}" controls>\n        <p>Ваш браузер не поддерживает HTML5 аудио/видео.\n        Используйте <a href="${r}">ссылку </a> для доступа.</p>\n      </video>\n      <span class="media__name">${et.formatTextSize(e.name,24,!1)}</span>`:"image"===n[0]?`<a href="${r}" target="_blank">\n      <img class="attachment__post-${n[0]}" data-id="${e.id}" src ="${r}"></a>\n      <span class="media__name">${et.formatTextSize(e.name,24,!0)}</span>`:`<div class="attachment__document" data-id="${e.id}">\n    <span class="document__icon">H</span><a href="${r}" target="_blank">\n    ${et.formatTextSize(e.name,28)}</a>\n    <span class="filesize">(${et.formatFileSize(e.size)})</span></div>`}}const pt=localStorage,mt=new class{constructor(t){this._Buttons=null,this._Request=null,this._Media=null,this.lastItem=null,this.msgCount=null,this.isLoading=!1,this.addCount=5,this.errorTime=1500,this.alertTimeout=[],this.feedType="feed",this.pinnedId=null,this.panelHeight={attachment:0,pinned:0},this.storage=t,this.feed=document.getElementById("feed"),this.main=document.querySelector(".main"),this.top=this.main.querySelector(".main__top"),this.content=this.main.querySelector(".main__content"),this.divDrop=this.main.querySelector("[data-id=drop-block]"),this.divError=this.main.querySelector(".main__error"),this.divSearch=this.top.querySelector(".main__search"),this.divAttach=this.content.querySelector(".main__attachments"),this.divSending=this.main.querySelector(".main__sending")}init(){this._Request=new lt,this._Media=new dt,this._Attachments=new ft(this.storage,this._Request.serverURL),this._Buttons=new ct(this),this._WebSocket=new ht(this),this._DragAndDrop=new ut(this,this.divDrop),this.feed.addEventListener("scroll",(()=>this.preloadContent("history"))),(async()=>{for(await this.pinMessage();await this.preloadContent("history"););Q(this._WebSocket.ws,"message").subscribe((t=>{"feed"===this.feedType&&this.getContent("unread",t.count)}))})()}async preloadContent(t){let e=!1;const n=await this._Request.send("feed",{pages:{start:"count",end:null}});return this.msgCount=n.count,et.checkScrollingDown(this.feed)&&this.msgCount>this.lastItem&&(e=!0),!(!e||this.isLoading||this._Buttons.isSending||(this.isLoading=!0,it.addLoader("ajax",this.feed,null,!1),await this.getContent(t,this.msgCount),it.removeLoader("ajax"),this.isLoading=!1,0))}async getContent(t,e=null){this.lastItem||(this.lastItem=0);const n="unread"===t?et.getPagesCounter(0,e-this.msgCount,!1):et.getPagesCounter(this.lastItem,this.addCount,!1),r=await this._Request.send("feed",{pages:n});if(r.error)return this.showAlert(r.response),!1;if(this.lastItem+=r.response.length,r.response.length<1)return!1;const i=r.response;for(let e=[],n=0;n<i.length;n++){if(i[n][1].attachCount>0){if(e=await this._Request.send("attachments/get",{id:i[n][0]}),e.error){this.showAlert(e.response);continue}}else e=[];this.createPost(i[n],e,"unread"===t?"afterbegin":"beforeend")}return!0}switchControl(...t){Array.from(t).forEach((t=>t.classList.toggle("hidden")))}showAlert(t,e="error"){this.alertTimeout.length>0&&(this.alertTimeout.forEach((t=>clearTimeout(t))),this.alertTimeout=[]);const n="animation-error",r=this.divError.querySelector(".error__message");["error","warning"].forEach((t=>this.divError.classList.remove(t))),r.textContent=t,this.divError.classList.add(e),this.divError.querySelector(".error__icon").textContent="error"!==e?"G":"P",this.divError.classList.add(n),this.divError.style.display="block",this.divError.addEventListener("animationend",(()=>{this.divError.classList.remove(n);const t=setTimeout((()=>{this.alertTimeout&&(this.divError.style.display="none",r.textContent="")}),this.errorTime);this.alertTimeout.push(t)}))}createPost(t,e=[],n="afterbegin"){const r=t[1],i=document.createElement("div"),o=e.length>0&&r.message.length>0?" wrapper":"",s=this.pinnedId===t[0]?"pin__button":"";let a=`<span class="message__text${o}">${et.formatUrlHTML(r.message)}</span>`;e.length>0&&e.forEach((t=>a+=this._Attachments.getMediaHTML(t.type,t))),i.classList.add("feed__message"),this.pinnedId===t[0]&&i.classList.add("pin__bg"),i.setAttribute("id",`messageId-${t[0]}`),i.innerHTML=`<div class="message__content">${a}</div>\n    <div class="message__control">\n      <button class="send-button ico ${s}" data-id="${t[0]}">l</button>\n    </div>\n    <span class="message__created">${et.getFormatedDate(r.created)}</span>`,this.feed.insertAdjacentElement(n,i),i.querySelector("button").addEventListener("click",(async e=>{it.addLoader("setpin",e.target,15),await this.pinMessage("set",t[0]),it.removeLoader("setpin")}))}createAttachment(t){const e=document.createElement("div"),n=URL.createObjectURL(t.blob),r="image"===t.type?`<div style="background: url(${n}); background-size: cover;" class="attachment__image" data-id="${t.id}">`:"";e.classList.add("attachment"),e.dataset.id=t.id,e.innerHTML=`<span class="attachment__icon">${rt[t.type]}</span><span class="attachment__name">${et.formatTextSize(t.name,18)}${r}</span><div class="attachment__remove">P</div>`,this.checkAttachments(e);const i=e.querySelector(".attachment__remove");i.addEventListener("click",(()=>this.removeAttachment(t.id,e))),e.addEventListener("click",(t=>{t.target!==i&&window.open(n,"_blank")}))}async removeAttachment(t,e){const n=this._Attachments.removeAttachment(t);n.error?this.showAlert(n.response):this.checkAttachments(e,"remove")}checkAttachments(t,e="add"){const n=this._Attachments.getAllAttachments();"remove"===e&&t.classList.add("animation-attachment");let r=0;function i(t){return r<t?t:r}n.forEach((t=>{"image"===t.type&&(r=i(70)),"audio"!==t.type&&"document"!==t.type&&"video"!==t.type||(r=i(20))})),this.heightBoard(r,"attachment"),"add"===e&&(this.divAttach.appendChild(t),t.classList.add("animation-attachment"),t.addEventListener("animationend",(()=>{"reverse"!==t.style.animationDirection?(t.classList.remove("animation-attachment"),t.style.animationDirection="reverse"):t.remove()})))}heightBoard(t,e="attachment"){let n=0;this.panelHeight[e]=t;for(const t of Object.keys(this.panelHeight))n+=this.panelHeight[t];this.divAttach.style.height=`${n}px`,this.feed.style.height=`calc(100vh - 140px - ${n}px)`}async pinMessage(t="get",e=null){if(this.pinnedId)return void this.showAlert("У вас уже есть закрепленное сообщение","warning");const n=await this._Request.send("get"===t?"pin/get":"pin/set",{id:e});if(n.error)return void("get"!==t&&this.showAlert(n.response));const[r,i]=n.response,o=(document.getElementById(`messageId-${e}`),document.createElement("div")),s=i.message?i.message:"(текст отсутствует)";o.classList.add("pinned"),o.style.animationDirection="reverse",o.innerHTML=`<span class="pinned__icon">P</span>\n      <div class="pinned__title">Pinned</div>\n      <div class="pinned__message">\n        <span class="icon">M</span><span>Сообщение:</span>\n        ${et.formatTextSize(s,32,!1)}\n      </div>\n      <div class="pinned__attachments">\n        <span class="icon">h</span><span>Прикреплений:</span> ${i.attachCount}\n      </div>`,this.divAttach.insertAdjacentElement("afterbegin",o),this.heightBoard(50,"pinned"),this.pinnedId=e||r,this.pinToggle(this.pinnedId),o.querySelector(".pinned__icon").addEventListener("click",(async t=>{it.addLoader("pin",t.target,15),o.classList.add("animation-attachment"),await this._Request.send("pin/set",{id:0}),this.pinToggle(this.pinnedId),this.pinnedId&&(this.pinnedId=null),it.removeLoader("pin")})),o.addEventListener("animationend",(()=>{this.heightBoard(0,"pinned"),o.remove()})),o.addEventListener("click",(async t=>{if(console.log(this.feedType),"feed"===this.feedType)t.target!==o.querySelector(".pinned__icon")&&await this._Buttons.startSearch(`force|${this.pinnedId},{`);else for(this.feed.innerHTML="",this.lastItem=null,this.msgCount=null,this.feedType="feed";await this.preloadContent("history"););}))}pinToggle(t){if(!t)return;const e=document.getElementById(`messageId-${t}`);e&&(e.classList.contains("pin__bg")?(e.classList.remove("pin__bg"),e.querySelector("button").classList.remove("pin__button")):(e.classList.add("pin__bg"),e.querySelector("button").classList.add("pin__button")))}}(pt);mt.init()}()}();